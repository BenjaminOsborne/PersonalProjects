@page "/"

<PageTitle>Account Processor</PageTitle>

<RenderModeHeader/>

<MudStack Row=true>
    <MudText Color=Color.Primary><strong>Last Action Result: </strong></MudText>
    <MudText Color=@(Model.LastActionResult?.IsSuccess == true ? Color.Success : Color.Error)>
        @(Model.LastActionResult?.IsSuccess == true ? "Success!" : Model.LastActionResult?.Error)
    </MudText>
</MudStack>

<MudDivider Class="ma-1" DividerType="DividerType.FullWidth" />

<MudTabs Elevation="2" Rounded="true" ApplyEffectsToContainer="true" @ref=@TabsRef>
    <MudTabPanel Text="File Actions">
        <FileActions Model=@Model OnFileActionFinished=@OnFileActionFinished />
    </MudTabPanel>
    
    <MudTabPanel Text="Categorise" Disabled=@(!TransactionsAreFullyLoaded()) @ref=@CategoriseTab>
        <MudStack Row=true Class="align-end mt-2">
            <MudPaper Elevation="0" Class="mb-3 d-flex justify-start flex-shrink-1">
                <MudDatePicker @bind-Date=@YearMonthBind FixDay=1 DateFormat="MMM yyyy" />
            </MudPaper>
            <MudIconButton Icon="@Icons.Material.Filled.ArrowBack" Size="Size.Medium" OnClick="() => Model.SkipMonthAsync(-1)" />
            <MudIconButton Icon="@Icons.Material.Filled.ArrowForward" Size="Size.Medium" OnClick="() => Model.SkipMonthAsync(+1)" />
            <MudIconButton Icon="@Icons.Material.Filled.Refresh" Size="Size.Medium" OnClick="() => Model.RefreshTransactionsAsync()" />
        </MudStack>

        <MudText Typo="Typo.caption"><strong>Transactions Period:</strong> @Model.EarliestTransaction?.ToString("dd MMM") to @Model.LatestTransaction?.ToString("dd MMM")</MudText>

        @* UnMatched Rows *@
        @if (Model.UnMatchedModel != null)
        {
            <UnMatchedRowsTable @ref="UnMatchedRowsTable" Model=@Model.UnMatchedModel AddNewMatchForRowAsync=@AddNewMatchForRowAsync />
        }

        @* Matched Rows *@
        @if (Model.MatchedModel != null)
        {
            <MatchedRowsTable @ref="MatchedRowsTable" Model=@Model.MatchedModel ClearMatchAsync=@ClearMatchAsync />
        }
    </MudTabPanel>

    @* Add new section *@
    <MudTabPanel Text="Add New Section" Disabled=@(!Model.Categories.HasValue)>
        <MudStack Row=true Class="align-center">
            <CategorySelector InitialCategoryValue=@Model.NewSectionCategory
                              Categories=@(Model.Categories!.Value.Select(x => x.Name).ToArray())
                              OnSetCategory=@(v => Model.NewSectionCategory = v) />
            <MudPaper Width="300px" MaxWidth="300px">
                <MudTextField T=string
                              @bind-Value=@Model.NewSectionName
                              Label="New Category Name"
                              Validation=@((string? n) => n == null ? "Enter name" : null)
                              Typo=Typo.subtitle1 />
            </MudPaper>
            <MudCheckBox @bind-Value=@Model.NewSectionIsMonthSpecific>Is Month Specific</MudCheckBox>
            <MudTooltip Text="Create">
                <MudIconButton Icon="@Icons.Material.Filled.Add" Size="Size.Large" Color="Color.Primary" OnClick="() => Model.CreateNewSectionAsync()" />
            </MudTooltip>
        </MudStack>
    </MudTabPanel>
</MudTabs>